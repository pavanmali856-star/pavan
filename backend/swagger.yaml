openapi: 3.0.0
info:
  title: Movie Ticket Booking System API
  description: |
    Enterprise-grade API for managing movies, theaters, screens, showtimes, seats, bookings, payments, and admin analytics.

    Notes:
    - Real-time seat updates are delivered via Socket.IO (see README).
    - Seat locking uses a TTL window (`SEAT_LOCK_TTL_MS`).
  version: 1.0.0
servers:
  - url: http://localhost:5050/api
    description: Local server
tags:
  - name: Auth
  - name: Movies
  - name: Theaters
  - name: Showtimes
  - name: Bookings
  - name: Payments
  - name: Admin
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    User:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
        role:
          type: string
          enum: [user, admin]
    AuthResponse:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        email:
          type: string
        role:
          type: string
          enum: [user, admin]
        token:
          type: string
    Movie:
      type: object
      properties:
        _id: { type: string }
        title: { type: string }
        description: { type: string }
        genre:
          type: array
          items: { type: string }
        duration: { type: number }
        language:
          type: array
          items: { type: string }
        releaseDate: { type: string, format: date-time }
        posterUrl: { type: string }
        trailerUrl: { type: string }
        rating: { type: number }
    Theater:
      type: object
      properties:
        _id: { type: string }
        name: { type: string }
        location:
          type: object
          properties:
            address: { type: string }
            city: { type: string }
            state: { type: string }
            zipCode: { type: string }
    Screen:
      type: object
      properties:
        _id: { type: string }
        theater: { type: string }
        name: { type: string }
        type: { type: string }
        capacity: { type: number }
    Showtime:
      type: object
      properties:
        _id: { type: string }
        movie: { type: string }
        theater: { type: string }
        screen: { type: string }
        startTime: { type: string, format: date-time }
        price: { type: number }
        seats:
          type: array
          items:
            type: object
            properties:
              row: { type: string }
              number: { type: number }
              type: { type: string }
              price: { type: number }
              status: { type: string, enum: [Available, Locked, Booked] }
    Booking:
      type: object
      properties:
        _id: { type: string }
        user: { type: string }
        showtime: { type: string }
        seats:
          type: array
          items:
            type: object
            properties:
              row: { type: string }
              number: { type: number }
              price: { type: number }
        totalAmount: { type: number }
        paymentId: { type: string }
        status: { type: string, enum: [Pending, Confirmed, Cancelled] }
    PaymentIntentResponse:
      type: object
      properties:
        clientSecret: { type: string }
        paymentId: { type: string }
        amount: { type: number }
        currency: { type: string }
        status: { type: string }

paths:
  /auth/register:
    post:
      summary: Register a new user
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password]
              properties:
                name:
                  type: string
                email:
                  type: string
                password:
                  type: string
      responses:
        201:
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        400:
          description: Invalid input or user already exists

  /auth/login:
    post:
      summary: Login user
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                password:
                  type: string
      responses:
        200:
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        400:
          description: Invalid credentials

  /auth/me:
    get:
      summary: Get current logged in user
      tags: [Auth]
      security:
        - bearerAuth: []
      responses:
        200:
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        401:
          description: Not authorized

  /movies:
    get:
      summary: List movies (filters + pagination)
      tags: [Movies]
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, default: 12 }
        - in: query
          name: genre
          schema: { type: string }
          description: Comma-separated genres
        - in: query
          name: language
          schema: { type: string }
          description: Comma-separated languages
        - in: query
          name: minRating
          schema: { type: number }
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: sort
          schema: { type: string, enum: [newest, rating, releaseDate], default: newest }
      responses:
        200:
          description: Movies page
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Movie' }
                  page: { type: integer }
                  limit: { type: integer }
                  total: { type: integer }
                  totalPages: { type: integer }
    post:
      summary: Create a movie (admin)
      tags: [Movies]
      security:
        - bearerAuth: []
      responses:
        201:
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Movie' }

  /movies/autocomplete:
    get:
      summary: Autocomplete movie titles
      tags: [Movies]
      parameters:
        - in: query
          name: q
          required: true
          schema: { type: string }
      responses:
        200:
          description: Suggestions

  /movies/recommendations:
    get:
      summary: Personalized recommendations (AI-lite)
      tags: [Movies]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Recommended movies

  /movies/{id}:
    get:
      summary: Get movie details
      tags: [Movies]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        200:
          description: Movie
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Movie' }

  /theaters:
    get:
      summary: List theaters
      tags: [Theaters]
      responses:
        200:
          description: Theaters
    post:
      summary: Create theater (admin)
      tags: [Theaters]
      security:
        - bearerAuth: []
      responses:
        201:
          description: Created

  /theaters/{id}/screens:
    get:
      summary: List screens for theater
      tags: [Theaters]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        200:
          description: Screens
    post:
      summary: Add screen to theater (admin)
      tags: [Theaters]
      security:
        - bearerAuth: []
      responses:
        201:
          description: Created

  /showtimes:
    get:
      summary: List showtimes (filters)
      tags: [Showtimes]
      parameters:
        - in: query
          name: movie
          schema: { type: string }
        - in: query
          name: theater
          schema: { type: string }
        - in: query
          name: date
          schema: { type: string }
      responses:
        200:
          description: Showtimes
    post:
      summary: Create showtime (admin)
      tags: [Showtimes]
      security:
        - bearerAuth: []
      responses:
        201:
          description: Created

  /showtimes/{id}:
    get:
      summary: Get showtime + seat map
      tags: [Showtimes]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        200:
          description: Showtime details

  /bookings/lock:
    post:
      summary: Lock seats (temporary hold)
      tags: [Bookings]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Locked

  /bookings/unlock:
    post:
      summary: Unlock seats (release hold)
      tags: [Bookings]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Released

  /bookings:
    post:
      summary: Create booking (confirm seats)
      tags: [Bookings]
      security:
        - bearerAuth: []
      responses:
        201:
          description: Booking created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Booking' }

  /bookings/mybookings:
    get:
      summary: Get my booking history
      tags: [Bookings]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Bookings

  /payments/create-intent:
    post:
      summary: Mock payment intent (Stripe/Razorpay simulation)
      tags: [Payments]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Payment intent
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PaymentIntentResponse' }

  /payments/verify:
    post:
      summary: Mock verify payment
      tags: [Payments]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Verified

  /admin/stats:
    get:
      summary: Admin overview stats
      tags: [Admin]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Stats

  /admin/revenue:
    get:
      summary: Revenue timeseries
      tags: [Admin]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Revenue series

  /admin/top-movies:
    get:
      summary: Top movies by revenue/bookings
      tags: [Admin]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Top movies

  /admin/bookings:
    get:
      summary: List bookings (admin)
      tags: [Admin]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Bookings page
